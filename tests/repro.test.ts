import { config, config_payload } from "./utils";
import fs from 'fs';
import { WasmModule, loadWasm } from "@steerprotocol/app-loader";

interface DataModel {
  open: number;
  high: number;
  close: number;
  low: number;
}

describe("WASM Module", () => {
  let myModule: WasmModule;
  
  beforeEach(async () => {
    myModule = await loadWasm(fs.readFileSync(__dirname + "/../build/debug.wasm"), {})
  });

  describe("Custom Strategy", () => {
    test("can run execute", async () => {        
      const prices3 = [
        {
          timestamp: 1684681200000,
          high: 148737878222.42038,
          low: 148737827004.56854,
          open: 148737853661.87207,
          close: 148737827004.56854,
          volume: 0.005577547478304474,
        },
        {
          timestamp: 1684684800000,
          high: 148737773203.07648,
          low: 148737773203.07648,
          open: 148737773203.07648,
          close: 148737773203.07648,
          volume: 0.002248618061969551,
        },
        {
          timestamp: 1684688400000,
          high: 148737808558.39902,
          low: 148737791798.34003,
          open: 148737791798.34003,
          close: 148737808558.39902,
          volume: 0.001483064524768401,
        },
        {
          timestamp: 1684692000000,
          high: 148737883266.20288,
          low: 148737836798.77078,
          open: 148737836798.77078,
          close: 148737883266.20288,
          volume: 0.003133790117239025,
        },
        {
          timestamp: 1684695600000,
          high: 148737929351.63382,
          low: 148737911306.70844,
          open: 148737911306.70844,
          close: 148737929351.63382,
          volume: 0.001933155351421828,
        },
        {
          timestamp: 1684699200000,
          high: 148738465740.60513,
          low: 148738465740.60513,
          open: 148738465740.60513,
          close: 148738465740.60513,
          volume: 0.0225,
        },
        {
          timestamp: 1684702800000,
          high: 148632148319.90482,
          low: 148632148319.90482,
          open: 148632148319.90482,
          close: 148632148319.90482,
          volume: 4.44717724904667,
        },
        {
          timestamp: 1684713600000,
          high: 148622536657.97522,
          low: 148622536657.97522,
          open: 148622536657.97522,
          close: 148622536657.97522,
          volume: 0.44445535337392145,
        },
        {
          timestamp: 1684724400000,
          high: 148622471791.26315,
          low: 148622471791.26315,
          open: 148622471791.26315,
          close: 148622471791.26315,
          volume: 0.003000688360294989,
        },
        {
          timestamp: 1684728000000,
          high: 148622457847.6565,
          low: 148622457847.6565,
          open: 148622457847.6565,
          close: 148622457847.6565,
          volume: 0.000645021497316454,
        },
        {
          timestamp: 1684731600000,
          high: 148622435206.97028,
          low: 148622393029.1881,
          open: 148622435206.97028,
          close: 148622393029.1881,
          volume: 0.0029984574332200973,
        },
        {
          timestamp: 1684735200000,
          high: 148622367776.50262,
          low: 148622296770.2265,
          open: 148622367776.50262,
          close: 148622296770.2265,
          volume: 0.004452874075539896,
        },
        {
          timestamp: 1684738800000,
          high: 148622279703.79636,
          low: 148622279703.79636,
          open: 148622279703.79636,
          close: 148622279703.79636,
          volume: 0.000789481595115003,
        },
        {
          timestamp: 1684742400000,
          high: 148622269451.7311,
          low: 148622269451.7311,
          open: 148622269451.7311,
          close: 148622269451.7311,
          volume: 0.000474253678177643,
        },
        {
          timestamp: 1684746000000,
          high: 148569545535.68475,
          low: 148529626595.57874,
          open: 148569545535.68475,
          close: 148529626595.57874,
          volume: 4.286264641854594,
        },
        {
          timestamp: 1684749600000,
          high: 148529639676.96677,
          low: 148433619848.63766,
          open: 148529639676.96677,
          close: 148433619848.63766,
          volume: 4.446240345836719,
        },
        {
          timestamp: 1684753200000,
          high: 148431595644.2739,
          low: 148374840143.1291,
          open: 148431595644.2739,
          close: 148374884960.75757,
          volume: 2.72319900906175,
        },
        {
          timestamp: 1684756800000,
          high: 148373482894.53384,
          low: 148355445015.09906,
          open: 148373482894.53384,
          close: 148355445015.09906,
          volume: 0.9000614256923262,
        },
        {
          timestamp: 1684760400000,
          high: 148347648211.80112,
          low: 148210824137.28244,
          open: 148347648211.80112,
          close: 148210824137.28244,
          volume: 6.697738720080814,
        },
        {
          timestamp: 1684764000000,
          high: 148210813042.94434,
          low: 148210781091.7447,
          open: 148210802304.16354,
          close: 148210813042.94434,
          volume: 0.003478579281592968,
        },
        {
          timestamp: 1684767600000,
          high: 148210790765.103,
          low: 148210741563.82196,
          open: 148210790765.103,
          close: 148210741994.27118,
          volume: 0.0033311769757347846,
        },
        {
          timestamp: 1684778400000,
          high: 148210718436.66287,
          low: 148210718436.66287,
          open: 148210718436.66287,
          close: 148210718436.66287,
          volume: 0.00109127560657648,
        },
        {
          timestamp: 1684782000000,
          high: 148210699239.98828,
          low: 148201152533.89014,
          open: 148210686584.1794,
          close: 148201152533.89014,
          volume: 0.44432775712785433,
        },
        {
          timestamp: 1684800000000,
          high: 148201120267.1851,
          low: 148201120267.1851,
          open: 148201120267.1851,
          close: 148201120267.1851,
          volume: 0.001495349466281415,
        },
        {
          timestamp: 1684803600000,
          high: 148163613575.85925,
          low: 147824962692.59702,
          open: 148076146748.8857,
          close: 147826063171.98618,
          volume: 17.491208748321004,
        },
        {
          timestamp: 1684807200000,
          high: 147808486693.19214,
          low: 147755716926.25723,
          open: 147808486693.19214,
          close: 147755716926.25723,
          volume: 3.3261895065880616,
        },
        {
          timestamp: 1684810800000,
          high: 147755697566.83105,
          low: 147134197353.16638,
          open: 147755697566.83105,
          close: 147134197353.16638,
          volume: 29.394058520410766,
        },
        {
          timestamp: 1684814400000,
          high: 147048618282.34082,
          low: 146962545744.28412,
          open: 146962598315.03433,
          close: 147048601678.36252,
          volume: 11.754130780868952,
        },
        {
          timestamp: 1684818000000,
          high: 147274639728.41312,
          low: 147135364366.56174,
          open: 147135364366.56174,
          close: 147274639728.41312,
          volume: 10.557003504328431,
        },
        {
          timestamp: 1684825200000,
          high: 147274626979.62024,
          low: 147274626979.62024,
          open: 147274626979.62024,
          close: 147274626979.62024,
          volume: 0.000605446017718361,
        },
        {
          timestamp: 1684828800000,
          high: 147274608332.45908,
          low: 147274574213.7144,
          open: 147274608332.45908,
          close: 147274574213.7144,
          volume: 0.0025058773291522533,
        },
        {
          timestamp: 1684836000000,
          high: 147274594612.65942,
          low: 147274594612.65942,
          open: 147274594612.65942,
          close: 147274594612.65942,
          volume: 0.00096690624679475,
        },
        {
          timestamp: 1684839600000,
          high: 147274598484.5421,
          low: 147274577760.38174,
          open: 147274598484.5421,
          close: 147274577760.38174,
          volume: 0.001144493208061288,
        },
        {
          timestamp: 1684854000000,
          high: 147275117978.77988,
          low: 147275117978.77988,
          open: 147275117978.77988,
          close: 147275117978.77988,
          volume: 0.0256,
        },
        {
          timestamp: 1684861200000,
          high: 147275658198.16876,
          low: 147275658198.16876,
          open: 147275658198.16876,
          close: 147275658198.16876,
          volume: 0.0256,
        },
        {
          timestamp: 1684872000000,
          high: 147276198416.39523,
          low: 147276198416.39523,
          open: 147276198416.39523,
          close: 147276198416.39523,
          volume: 0.0256,
        },
        {
          timestamp: 1684890000000,
          high: 147276219399.39474,
          low: 147276219399.39474,
          open: 147276219399.39474,
          close: 147276219399.39474,
          volume: 0.000993495190928908,
        },
        {
          timestamp: 1684893600000,
          high: 147276235498.85437,
          low: 147276235498.85437,
          open: 147276235498.85437,
          close: 147276235498.85437,
          volume: 0.000762271127440058,
        },
        {
          timestamp: 1684897200000,
          high: 147276319077.2222,
          low: 147276265952.19315,
          open: 147276265952.19315,
          close: 147276319077.2222,
          volume: 0.003910611815041732,
        },
        {
          timestamp: 1684900800000,
          high: 147254609749.11136,
          low: 147254609749.11136,
          open: 147254609749.11136,
          close: 147254609749.11136,
          volume: 1.0058424109854514,
        },
        {
          timestamp: 1684904400000,
          high: 147254624149.8535,
          low: 147211448621.0942,
          open: 147254624149.8535,
          close: 147211448621.0942,
          volume: 2.001309714398255,
        },
        {
          timestamp: 1684908000000,
          high: 147204356900.60254,
          low: 147177795943.39706,
          open: 147204356900.60254,
          close: 147177795943.39706,
          volume: 1.5645278485418466,
        },
        {
          timestamp: 1684915200000,
          high: 147177780865.5233,
          low: 147177780865.5233,
          open: 147177780865.5233,
          close: 147177780865.5233,
          volume: 0.000698800139344376,
        },
        {
          timestamp: 1684918800000,
          high: 147177768344.03052,
          low: 147177708191.34747,
          open: 147177768344.03052,
          close: 147177708191.34747,
          volume: 0.003368162683533139,
        },
        {
          timestamp: 1684926000000,
          high: 147178245640.45566,
          low: 147177689902.50354,
          open: 147177689902.50354,
          close: 147178245640.45566,
          volume: 0.026439943128460805,
        },
        {
          timestamp: 1684929600000,
          high: 147178804286.904,
          low: 147178804286.904,
          open: 147178804286.904,
          close: 147178804286.904,
          volume: 0.0256,
        },
        {
          timestamp: 1684933200000,
          high: 147120426953.74664,
          low: 147087187729.2359,
          open: 147120426953.74664,
          close: 147087187729.2359,
          volume: 4.128069637943022,
        },
        {
          timestamp: 1684940400000,
          high: 147061962098.704,
          low: 146963196794.22922,
          open: 147061962098.704,
          close: 146963196794.22922,
          volume: 5.551549764531712,
        },
        {
          timestamp: 1684944000000,
          high: 146963164634.0308,
          low: 146963164634.0308,
          open: 146963164634.0308,
          close: 146963164634.0308,
          volume: 0.001440239170998465,
        },
        {
          timestamp: 1684947600000,
          high: 146963734545.28232,
          low: 146963734545.28232,
          open: 146963734545.28232,
          close: 146963734545.28232,
          volume: 0.0256,
        },
        {
          timestamp: 1684962000000,
          high: 146963117742.14066,
          low: 146963117742.14066,
          open: 146963117742.14066,
          close: 146963117742.14066,
          volume: 0.0284287521166031,
        },
        {
          timestamp: 1684969200000,
          high: 146963144109.76367,
          low: 146963144109.76367,
          open: 146963144109.76367,
          close: 146963144109.76367,
          volume: 0.001219015096472538,
        },
        {
          timestamp: 1684972800000,
          high: 146894708083.37827,
          low: 146867036744.16794,
          open: 146894660499.1579,
          close: 146867036744.16794,
          volume: 4.434977797292253,
        },
        {
          timestamp: 1684976400000,
          high: 146867066627.69016,
          low: 146867066627.69016,
          open: 146867066627.69016,
          close: 146867066627.69016,
          volume: 0.001381891932263578,
        },
        {
          timestamp: 1684983600000,
          high: 146867103101.96124,
          low: 146867103101.96124,
          open: 146867103101.96124,
          close: 146867103101.96124,
          volume: 0.001686658176093619,
        },
        {
          timestamp: 1684987200000,
          high: 147140469588.26956,
          low: 146917723252.11102,
          open: 146917723252.11102,
          close: 147140469588.26956,
          volume: 12.63524737993198,
        },
        {
          timestamp: 1684990800000,
          high: 147140492084.61877,
          low: 147140492084.61877,
          open: 147140492084.61877,
          close: 147140492084.61877,
          volume: 0.001039318482212286,
        },
        {
          timestamp: 1684994400000,
          high: 147140506428.56702,
          low: 147140469966.75006,
          open: 147140506428.56702,
          close: 147140469966.75006,
          volume: 0.002342143708319624,
        },
        {
          timestamp: 1684998000000,
          high: 147140537757.83142,
          low: 147140489611.16348,
          open: 147140489611.16348,
          close: 147140537757.83142,
          volume: 0.00313190899754306,
        },
        {
          timestamp: 1685001600000,
          high: 147140559120.6218,
          low: 147140559120.6218,
          open: 147140559120.6218,
          close: 147140559120.6218,
          volume: 0.00098799261318136,
        },
        {
          timestamp: 1685005200000,
          high: 147140595296.63632,
          low: 147140573205.7288,
          open: 147140573205.7288,
          close: 147140595296.63632,
          volume: 0.00167307879846753,
        },
        {
          timestamp: 1685016000000,
          high: 146961757532.9491,
          low: 146931858392.55777,
          open: 146961757532.9491,
          close: 146932411534.32867,
          volume: 9.653778934672927,
        },
        {
          timestamp: 1685019600000,
          high: 146877767913.38785,
          low: 146877746676.1461,
          open: 146877767913.38785,
          close: 146877746676.1461,
          volume: 2.522591246264749,
        },
      ]
      // The actual strategy instantiation and execution
      myModule.initialize(JSON.stringify({
        lookback: 72,
        multiplier: 1.1,
        poolFee: 3000,
        liquidityShape: "Linear"
      }));
      // Here we pin the array to the WASM memory
      // let priceMemoryRef = myModule.__pin(
      //   myModule.__newString(JSON.stringify(prices))
      // );

      // Call the config function on the strategy bundle
      const result = myModule.execute(JSON.stringify([...prices3]));
      
      // Pull the result from memory and parse the result
      const parsedResult = JSON.parse(result);

      // The result should match the given config
      expect(JSON.stringify(parsedResult)).toStrictEqual(
        `{\"functionName\":\"tend(uint256,(int24[],int24[],uint16[]),bytes)\",\"typesArray\":[\"uint256\",\"tuple(int24[],int24[],uint16[])\",\"bytes\"],\"valuesArray\":[10000,[[63300],[63420],[134]],\"0x7fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff000000000000000000000000ffffffffffffffffffffffffffffffffffffffff\"]}`
      );

      expect(parsedResult.valuesArray[1][0][0]).not.toEqual(parsedResult.valuesArray[1][1][0])
    });

  });
});